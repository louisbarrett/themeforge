/**
 * Theme Installer
 * Handles installing themes directly to VSCode/Cursor extensions folders
 * Works with both Electron native APIs and web File System Access API
 */

class ThemeInstaller {
    constructor() {
        // Check if we're running in Electron
        this.isElectron = !!(window.electronAPI && window.electronAPI.isElectron);
        
        // Extension paths by platform (used for hints in web mode)
        this.extensionPaths = {
            cursor: {
                mac: '~/.cursor/extensions',
                windows: '%USERPROFILE%\\.cursor\\extensions',
                linux: '~/.cursor/extensions'
            },
            vscode: {
                mac: '~/.vscode/extensions',
                windows: '%USERPROFILE%\\.vscode\\extensions', 
                linux: '~/.vscode/extensions'
            }
        };

        // Check for File System Access API support (web fallback)
        this.hasFileSystemAccess = 'showDirectoryPicker' in window;
        
        // Cache extension paths in Electron mode
        this._extensionPathsCache = null;
    }

    /**
     * Get actual extension paths (Electron only)
     */
    async getExtensionPaths() {
        if (!this.isElectron) {
            return null;
        }
        
        if (!this._extensionPathsCache) {
            this._extensionPathsCache = await window.electronAPI.getExtensionPaths();
        }
        
        return this._extensionPathsCache;
    }

    /**
     * Check installations (Electron only)
     */
    async checkInstallations() {
        if (!this.isElectron) {
            return { cursor: { installed: false }, vscode: { installed: false } };
        }
        
        return await window.electronAPI.checkInstallations();
    }

    /**
     * Generate extension folder name
     * Format: publisher.extension-name-version
     */
    getExtensionFolderName(theme) {
        const themeName = theme.name || 'Generated Theme';
        const slug = themeName.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
        return `themeforge.${slug}-1.0.0`;
    }

    /**
     * Generate the complete extension package structure
     */
    generateExtensionPackage(theme) {
        const themeName = theme.name || 'Generated Theme';
        const themeSlug = themeName.toLowerCase()
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-|-$/g, '');
        
        const extensionId = `themeforge.${themeSlug}`;
        const themeFileName = `${themeSlug}-color-theme.json`;

        // Package.json for the extension
        const packageJson = {
            name: themeSlug,
            displayName: themeName,
            description: `A beautiful ${theme.type || 'dark'} theme generated by ThemeForge`,
            version: '1.0.0',
            publisher: 'themeforge',
            author: 'ThemeForge AI',
            license: 'MIT',
            engines: {
                vscode: '^1.60.0'
            },
            categories: ['Themes'],
            keywords: ['theme', 'color-theme', 'themeforge', 'ai-generated'],
            contributes: {
                themes: [{
                    label: themeName,
                    uiTheme: theme.type === 'light' ? 'vs' : 'vs-dark',
                    path: `./themes/${themeFileName}`
                }]
            },
            repository: {
                type: 'git',
                url: 'https://github.com/themeforge/generated-themes'
            },
            __metadata: {
                id: extensionId,
                publisherId: 'themeforge',
                publisherDisplayName: 'ThemeForge'
            }
        };

        // Theme color file (cleaned up, without internal palette)
        const themeFile = {
            name: themeName,
            type: theme.type || 'dark',
            colors: theme.colors || {},
            tokenColors: theme.tokenColors || [],
            semanticHighlighting: theme.semanticHighlighting !== false,
            semanticTokenColors: theme.semanticTokenColors || {}
        };

        // README for the extension
        const readme = `# ${themeName}

A beautiful ${theme.type || 'dark'} color theme generated by [ThemeForge](https://github.com/themeforge).

## Installation

This theme was installed directly from ThemeForge.

## Preview

![Theme Preview](https://via.placeholder.com/800x500/1a1b26/c0caf5?text=${encodeURIComponent(themeName)})

## Colors

\`\`\`
Background: ${theme.palette?.background || theme.colors?.['editor.background'] || '#1a1b26'}
Foreground: ${theme.palette?.foreground || theme.colors?.['editor.foreground'] || '#c0caf5'}
Accent: ${theme.palette?.accent || theme.colors?.['focusBorder'] || '#7aa2f7'}
\`\`\`

## License

MIT License - Feel free to modify and share!

---
Generated with ❤️ by ThemeForge AI
`;

        // CHANGELOG
        const changelog = `# Changelog

## 1.0.0 - ${new Date().toISOString().split('T')[0]}

- Initial release
- Generated by ThemeForge AI
`;

        return {
            folderName: `${extensionId}-1.0.0`,
            files: {
                'package.json': JSON.stringify(packageJson, null, 2),
                'README.md': readme,
                'CHANGELOG.md': changelog,
                [`themes/${themeFileName}`]: JSON.stringify(themeFile, null, 2)
            }
        };
    }

    /**
     * Install theme directly using Electron native APIs
     */
    async installToFolderElectron(theme, targetApp = 'cursor') {
        if (!this.isElectron) {
            throw new Error('Native installation not available in web mode');
        }

        const extensionPackage = this.generateExtensionPackage(theme);
        const installations = await this.checkInstallations();
        const targetInfo = installations[targetApp];
        
        let extensionsPath;
        
        // If target app extensions folder exists, use it directly
        if (targetInfo.installed) {
            extensionsPath = targetInfo.path;
        } else {
            // Otherwise, let user select the directory
            const result = await window.electronAPI.selectDirectory({
                title: `Select ${targetApp === 'cursor' ? 'Cursor' : 'VS Code'} Extensions Folder`,
                defaultPath: targetInfo.path
            });
            
            if (result.canceled) {
                throw new Error('Installation cancelled');
            }
            
            extensionsPath = result.path;
        }

        // Install the theme
        const result = await window.electronAPI.installTheme({
            extensionsPath,
            folderName: extensionPackage.folderName,
            files: extensionPackage.files
        });

        if (!result.success) {
            throw new Error(result.error || 'Failed to install theme');
        }

        return {
            success: true,
            folderName: extensionPackage.folderName,
            path: result.path,
            message: `Theme installed successfully! Restart ${targetApp === 'cursor' ? 'Cursor' : 'VS Code'} to apply.`
        };
    }

    /**
     * Install theme directly to a folder using File System Access API (web fallback)
     */
    async installToFolderWeb(theme, targetApp = 'cursor') {
        if (!this.hasFileSystemAccess) {
            throw new Error('File System Access API not supported. Please use the ZIP download option.');
        }

        const extensionPackage = this.generateExtensionPackage(theme);
        const hint = this.extensionPaths[targetApp]?.mac || this.extensionPaths.cursor.mac;

        try {
            // Prompt user to select the extensions directory
            const directoryHandle = await window.showDirectoryPicker({
                id: `${targetApp}-extensions`,
                mode: 'readwrite',
                startIn: 'documents'
            });

            // Create the extension folder
            const extensionFolderHandle = await directoryHandle.getDirectoryHandle(
                extensionPackage.folderName,
                { create: true }
            );

            // Write all files
            for (const [filePath, content] of Object.entries(extensionPackage.files)) {
                await this.writeFileWeb(extensionFolderHandle, filePath, content);
            }

            return {
                success: true,
                folderName: extensionPackage.folderName,
                message: `Theme installed to ${extensionPackage.folderName}. Restart ${targetApp === 'cursor' ? 'Cursor' : 'VS Code'} to apply.`
            };

        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('Installation cancelled');
            }
            throw error;
        }
    }

    /**
     * Write a file to a directory handle (web File System Access API)
     */
    async writeFileWeb(directoryHandle, filePath, content) {
        const parts = filePath.split('/');
        const fileName = parts.pop();
        
        // Navigate/create nested directories
        let currentDir = directoryHandle;
        for (const dirName of parts) {
            currentDir = await currentDir.getDirectoryHandle(dirName, { create: true });
        }

        // Create and write the file
        const fileHandle = await currentDir.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(content);
        await writable.close();
    }

    /**
     * Install theme to folder (auto-selects method based on environment)
     */
    async installToFolder(theme, targetApp = 'cursor') {
        if (this.isElectron) {
            return this.installToFolderElectron(theme, targetApp);
        } else {
            return this.installToFolderWeb(theme, targetApp);
        }
    }

    /**
     * Create a ZIP file for the extension package
     */
    async createZipPackage(theme) {
        if (typeof JSZip === 'undefined') {
            throw new Error('JSZip library not loaded');
        }

        const extensionPackage = this.generateExtensionPackage(theme);
        const zip = new JSZip();
        
        // Create the extension folder in the zip
        const folder = zip.folder(extensionPackage.folderName);

        // Add all files to the zip
        for (const [filePath, content] of Object.entries(extensionPackage.files)) {
            folder.file(filePath, content);
        }

        // Generate the zip blob
        const blob = await zip.generateAsync({ 
            type: 'blob',
            compression: 'DEFLATE',
            compressionOptions: { level: 9 }
        });

        return {
            blob,
            fileName: `${extensionPackage.folderName}.zip`,
            folderName: extensionPackage.folderName
        };
    }

    /**
     * Download the theme as a ZIP file
     */
    async downloadAsZip(theme) {
        const { blob, fileName } = await this.createZipPackage(theme);
        
        if (this.isElectron) {
            // Use Electron's save dialog
            const arrayBuffer = await blob.arrayBuffer();
            const base64 = this.arrayBufferToBase64(arrayBuffer);
            
            const result = await window.electronAPI.saveFile({
                defaultName: fileName,
                content: base64,
                filters: [
                    { name: 'ZIP Archive', extensions: ['zip'] }
                ]
            });
            
            if (result.canceled) {
                throw new Error('Save cancelled');
            }
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to save file');
            }
            
            return { success: true, fileName: result.filePath };
        } else {
            // Web: Create download link
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            return { success: true, fileName };
        }
    }

    /**
     * Download theme as JSON
     */
    async downloadAsJson(theme) {
        const themeName = theme.name || 'generated-theme';
        const themeSlug = themeName.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const fileName = `${themeSlug}.json`;
        const content = JSON.stringify(theme, null, 2);
        
        if (this.isElectron) {
            const result = await window.electronAPI.saveJson({
                defaultName: fileName,
                content: content
            });
            
            if (result.canceled) {
                throw new Error('Save cancelled');
            }
            
            if (!result.success) {
                throw new Error(result.error || 'Failed to save file');
            }
            
            return { success: true, fileName: result.filePath };
        } else {
            // Web: Create download link
            const blob = new Blob([content], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            return { success: true, fileName };
        }
    }

    /**
     * Convert ArrayBuffer to Base64
     */
    arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    /**
     * Get installation instructions for manual installation
     */
    getInstallInstructions(targetApp = 'cursor') {
        const paths = this.extensionPaths[targetApp];
        const appName = targetApp === 'cursor' ? 'Cursor' : 'VS Code';
        
        return `
## Manual Installation

1. Download the theme ZIP file
2. Extract the ZIP file
3. Copy the extracted folder to your extensions directory:
   - **macOS/Linux**: ${paths.mac}
   - **Windows**: ${paths.windows}
4. Restart ${appName}
5. Open Command Palette (Cmd/Ctrl + Shift + P)
6. Type "Color Theme" and select your new theme

## Extensions Directory Location

The extensions folder should already exist if you have ${appName} installed.
If it doesn't exist, you can create it manually.
        `.trim();
    }

    /**
     * Check if we can use direct installation
     */
    canInstallDirectly() {
        return this.isElectron || this.hasFileSystemAccess;
    }

    /**
     * Open extension folder in file manager (Electron only)
     */
    async openExtensionFolder(targetApp = 'cursor') {
        if (!this.isElectron) {
            return { success: false, error: 'Not available in web mode' };
        }
        
        const paths = await this.getExtensionPaths();
        const folderPath = paths[targetApp];
        
        return await window.electronAPI.openFolder(folderPath);
    }
}

// Export
window.ThemeInstaller = ThemeInstaller;
